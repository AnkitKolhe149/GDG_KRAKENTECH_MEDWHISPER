{% extends "base.html" %}

{% block title %}Dashboard - MedWhisper{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
<style>
    body {
        perspective: 1000px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="fw-bold" style="color: var(--heading-color); font-size: 2.5rem; letter-spacing: -1px;">
                <i class="fas fa-tachometer-alt me-3"></i> Health Dashboard
            </h2>
            <p class="text-muted" id="welcomeMessage" style="font-size: 1.1rem;">Welcome back!</p>
        </div>
    </div>

    <!-- Quick Actions Cards -->
    <div class="row mb-5">
        <div class="col-md-4 mb-4">
            <div class="quick-action-card card">
                <div class="card-body">
                    <i class="fas fa-plus-circle text-primary"></i>
                    <h5 style="color: var(--heading-color);">Add Health Data</h5>
                    <p class="text-muted">Input your latest lab results, lifestyle, and mental health data</p>
                    <a href="/data-input" class="btn btn-primary">Add Data</a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="quick-action-card card">
                <div class="card-body">
                    <i class="fas fa-chart-line text-success"></i>
                    <h5 style="color: var(--heading-color);">Generate Assessment</h5>
                    <p class="text-muted">Get AI-powered risk assessment and recommendations</p>
                    <button class="btn btn-success" onclick="generateAssessment()">Generate Now</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="quick-action-card card">
                <div class="card-body">
                    <i class="fas fa-file-medical text-info"></i>
                    <h5 style="color: var(--heading-color);">View Report</h5>
                    <p class="text-muted">Access your latest risk assessment report</p>
                    <a href="/risk-report" class="btn btn-info">View Report</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Risk Assessment -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card assessment-card-container">
                <div class="assessment-header">
                    <h5>
                        <i class="fas fa-clipboard-list me-2"></i> Latest Risk Assessment
                    </h5>
                </div>
                <div class="assessment-body" id="latestAssessment">
                    <div class="assessment-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="loading-text">Analyzing your health data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Data Completeness -->
    <div class="row">
        <div class="col-12">
            <div class="card data-completeness-container">
                <div class="completeness-header">
                    <h5>
                        <i class="fas fa-database me-2"></i> Data Completeness
                    </h5>
                </div>
                <div class="completeness-body" id="dataCompleteness">
                    <div class="assessment-loading">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="loading-text">Loading data summary...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Check authentication on page load
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.displayName || user.email}!`;
            loadLatestAssessment();
            loadDataCompleteness();
        } else {
            window.location.href = '/';
        }
    });

    async function loadLatestAssessment() {
        try {
            const result = await apiCall('/api/assessment/latest');
            
            if (result.success && result.report) {
                displayLatestAssessment(result.report);
            } else {
                document.getElementById('latestAssessment').innerHTML = `
                    <div class="assessment-loading">
                        <i class="fas fa-exclamation-circle fa-4x text-warning mb-3" style="opacity: 0.8;"></i>
                        <h5 style="color: var(--heading-color); margin: 0;">No Assessment Found</h5>
                        <p class="text-muted mt-2">Generate your first risk assessment to see results here.</p>
                        <button class="btn btn-primary mt-3" onclick="generateAssessment()">
                            <i class="fas fa-flask me-2"></i> Generate Assessment
                        </button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading assessment:', error);
            document.getElementById('latestAssessment').innerHTML = `
                <div class="alert alert-danger">Failed to load assessment</div>
            `;
        }
    }

    function calculateDynamicScore(assessments) {
        // Calculate overall score based on disease assessments
        let totalWeightedScore = 0;
        let totalWeight = 0;
        
        const riskLevelWeights = {
            'very_high': 1.0,
            'high': 0.9,
            'medium': 0.6,
            'low': 0.3
        };
        
        for (const [disease, assessment] of Object.entries(assessments)) {
            const weight = riskLevelWeights[assessment.risk_level] || 0.5;
            const weightedScore = assessment.risk_score * weight;
            totalWeightedScore += weightedScore;
            totalWeight += weight;
        }
        
        return Math.round(totalWeightedScore / totalWeight);
    }

    function displayLatestAssessment(report) {
        const assessmentDiv = document.getElementById('latestAssessment');
        const dynamicScore = calculateDynamicScore(report.risk_assessments);
        
        let html = `
            <div class="row mb-4 pb-4" style="border-bottom: 2px solid var(--card-border);">
                <div class="col-md-6">
                    <p class="report-date-info"><strong>Report Date:</strong> ${new Date(report.report_date).toLocaleDateString()}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h4 style="color: var(--heading-color); margin: 0;">Overall Risk Score: <span class="overall-score-badge">${dynamicScore}%</span></h4>
                </div>
            </div>
            <div class="disease-assessment-grid">
        `;
        
        for (const [disease, assessment] of Object.entries(report.risk_assessments)) {
            const riskClass = `risk-${assessment.risk_level.replace('_', '-')}`;
            html += `
                <div class="disease-card-item">
                    <div class="disease-name">${disease.replace('_', ' ')}</div>
                    <div class="risk-score-container">
                        <span class="risk-badge ${riskClass}">${assessment.risk_level.replace('_', ' ').toUpperCase()}</span>
                        <span class="risk-score-number">${assessment.risk_score}%</span>
                    </div>
                    <div class="disease-confidence">Confidence: ${assessment.confidence}</div>
                </div>
            `;
        }
        
        html += '</div>';
        assessmentDiv.innerHTML = html;
    }

    async function loadDataCompleteness() {
        try {
            const result = await apiCall('/api/data/history');
            
            if (result.success && result.data) {
                displayDataCompleteness(result.data);
            }
        } catch (error) {
            console.error('Error loading data completeness:', error);
        }
    }

    function displayDataCompleteness(data) {
        const completenessDiv = document.getElementById('dataCompleteness');
        
        const dataTypes = [
            { key: 'lab_data', label: 'Lab Results', icon: 'flask' },
            { key: 'lifestyle_data', label: 'Lifestyle Data', icon: 'running' },
            { key: 'mental_health_data', label: 'Mental Health', icon: 'brain' },
            { key: 'family_history', label: 'Family History', icon: 'dna' }
        ];
        
        let html = '<div class="data-type-grid">';
        
        dataTypes.forEach(type => {
            const hasData = data[type.key] && (Array.isArray(data[type.key]) ? data[type.key].length > 0 : Object.keys(data[type.key]).length > 0);
            const iconColor = hasData ? 'success' : 'secondary';
            const statusText = hasData ? 'Available' : 'Not Added';
            const statusClass = hasData ? 'status-available' : 'status-not-added';
            
            html += `
                <div class="data-type-item">
                    <i class="fas fa-${type.icon} fa-2x text-${iconColor} data-icon"></i>
                    <div class="data-info">
                        <div class="data-label">${type.label}</div>
                        <div class="data-status ${statusClass}">${statusText}</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        completenessDiv.innerHTML = html;
    }

    async function generateAssessment() {
        if (!confirm('Generate a new risk assessment? This will analyze all your health data.')) {
            return;
        }
        
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
        
        try {
            const result = await apiCall('/api/assessment/generate', 'POST');
            
            if (result.success) {
                alert('Risk assessment generated successfully!');
                window.location.href = '/risk-report';
            } else {
                alert(result.error || 'Failed to generate assessment');
            }
        } catch (error) {
            console.error('Error generating assessment:', error);
            alert('Failed to generate assessment. Please try again.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generate Now';
        }
    }
</script>
{% endblock %}
