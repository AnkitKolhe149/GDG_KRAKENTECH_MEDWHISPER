{% extends "base.html" %}

{% block title %}Dashboard - MedWhisper{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
<style>
    body {
        perspective: 1000px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="fw-bold" style="color: var(--heading-color); font-size: 2.5rem; letter-spacing: -1px;">
                <i class="fas fa-tachometer-alt me-3"></i> Health Dashboard
            </h2>
            <p class="text-muted" id="welcomeMessage" style="font-size: 1.1rem;">Welcome back!</p>
        </div>
    </div>

    <!-- Quick Actions Cards -->
    <div class="row mb-5">
        <div class="col-md-4 mb-4">
            <div class="quick-action-card card">
                <div class="card-body">
                    <i class="fas fa-plus-circle text-primary"></i>
                    <h5 style="color: var(--heading-color);">Add Health Data</h5>
                    <p class="text-muted">Input your latest lab results, lifestyle, and mental health data</p>
                    <a href="/data-input" class="btn btn-primary">Add Data</a>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="quick-action-card card">
                <div class="card-body">
                    <i class="fas fa-chart-line text-success"></i>
                    <h5 style="color: var(--heading-color);">Generate Assessment</h5>
                    <p class="text-muted">Get AI-powered risk assessment and recommendations</p>
                    <button class="btn btn-success" onclick="generateAssessment()">Generate Now</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="quick-action-card card">
                <div class="card-body">
                    <i class="fas fa-file-medical text-info"></i>
                    <h5 style="color: var(--heading-color);">View Report</h5>
                    <p class="text-muted">Access your latest risk assessment report</p>
                    <a href="/risk-report" class="btn btn-info">View Report</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Latest Risk Assessment -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card assessment-card-container">
                <div class="assessment-header">
                    <h5>
                        <i class="fas fa-clipboard-list me-2"></i> Latest Risk Assessment
                    </h5>
                </div>
                <div class="assessment-body" id="latestAssessment">
                    <div class="assessment-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="loading-text">Analyzing your health data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Data Completeness -->
    <div class="row">
        <div class="col-12">
            <div class="card data-completeness-container">
                <div class="completeness-header">
                    <h5>
                        <i class="fas fa-database me-2"></i> Data Completeness
                    </h5>
                </div>
                <div class="completeness-body" id="dataCompleteness">
                    <div class="assessment-loading">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="loading-text">Loading data summary...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Find Doctors Near You -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card" style="background-color: var(--card-bg); border-color: var(--card-border);">
                <div class="card-header" style="background-color: var(--card-bg); border-bottom-color: var(--card-border);">
                    <h5 class="mb-0" style="color: var(--heading-color);">
                        <i class="fas fa-user-md me-2"></i> Find Doctors Near You
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label" for="doctorArea">Area (fixed)</label>
                            <input type="text" class="form-control" id="doctorArea" value="Nagpur" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="doctorLat">Latitude</label>
                            <input type="text" class="form-control" id="doctorLat" placeholder="Disabled" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="doctorLon">Longitude</label>
                            <input type="text" class="form-control" id="doctorLon" placeholder="Disabled" disabled>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label" for="doctorRadius">Radius (km)</label>
                            <input type="number" class="form-control" id="doctorRadius" value="20" min="1" max="100">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="doctorSearchBtn" onclick="searchDoctors()">
                            <i class="fas fa-search me-2"></i> Search Doctors
                        </button>
                        <small class="text-muted ms-2">Location is fixed to Nagpur.</small>
                    </div>
                    <div class="mt-4" id="doctorResults">
                        <p class="text-muted">Enter location and click search to see nearby doctors.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Check authentication on page load
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.displayName || user.email}!`;
            loadLatestAssessment();
            loadDataCompleteness();
        } else {
            window.location.href = '/';
        }
    });

    async function loadLatestAssessment() {
        try {
            const result = await apiCall('/api/assessment/latest');
            
            if (result.success && result.report) {
                displayLatestAssessment(result.report);
            } else {
                document.getElementById('latestAssessment').innerHTML = `
                    <div class="assessment-loading">
                        <i class="fas fa-exclamation-circle fa-4x text-warning mb-3" style="opacity: 0.8;"></i>
                        <h5 style="color: var(--heading-color); margin: 0;">No Assessment Found</h5>
                        <p class="text-muted mt-2">Generate your first risk assessment to see results here.</p>
                        <button class="btn btn-primary mt-3" onclick="generateAssessment()">
                            <i class="fas fa-flask me-2"></i> Generate Assessment
                        </button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading assessment:', error);
            document.getElementById('latestAssessment').innerHTML = `
                <div class="alert alert-danger">Failed to load assessment</div>
            `;
        }
    }

    function calculateDynamicScore(assessments) {
        // Calculate overall score based on disease assessments
        let totalWeightedScore = 0;
        let totalWeight = 0;
        
        const riskLevelWeights = {
            'very_high': 1.0,
            'high': 0.9,
            'medium': 0.6,
            'low': 0.3
        };
        
        for (const [disease, assessment] of Object.entries(assessments)) {
            const weight = riskLevelWeights[assessment.risk_level] || 0.5;
            const weightedScore = assessment.risk_score * weight;
            totalWeightedScore += weightedScore;
            totalWeight += weight;
        }
        
        return Math.round(totalWeightedScore / totalWeight);
    }

    function displayLatestAssessment(report) {
        const assessmentDiv = document.getElementById('latestAssessment');
        const dynamicScore = calculateDynamicScore(report.risk_assessments);
        
        let html = `
            <div class="row mb-4 pb-4" style="border-bottom: 2px solid var(--card-border);">
                <div class="col-md-6">
                    <p class="report-date-info"><strong>Report Date:</strong> ${new Date(report.report_date).toLocaleDateString()}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h4 style="color: var(--heading-color); margin: 0;">Overall Risk Score: <span class="overall-score-badge">${dynamicScore}%</span></h4>
                </div>
            </div>
            <div class="disease-assessment-grid">
        `;
        
        for (const [disease, assessment] of Object.entries(report.risk_assessments)) {
            const riskClass = `risk-${assessment.risk_level.replace('_', '-')}`;
            html += `
                <div class="disease-card-item">
                    <div class="disease-name">${disease.replace('_', ' ')}</div>
                    <div class="risk-score-container">
                        <span class="risk-badge ${riskClass}">${assessment.risk_level.replace('_', ' ').toUpperCase()}</span>
                        <span class="risk-score-number">${assessment.risk_score}%</span>
                    </div>
                    <div class="disease-confidence">Confidence: ${assessment.confidence}</div>
                </div>
            `;
        }
        
        html += '</div>';
        assessmentDiv.innerHTML = html;
    }

    async function loadDataCompleteness() {
        try {
            const result = await apiCall('/api/data/history');
            
            if (result.success && result.data) {
                displayDataCompleteness(result.data);
            }
        } catch (error) {
            console.error('Error loading data completeness:', error);
        }
    }

    function displayDataCompleteness(data) {
        const completenessDiv = document.getElementById('dataCompleteness');
        
        const dataTypes = [
            { key: 'lab_data', label: 'Lab Results', icon: 'flask' },
            { key: 'lifestyle_data', label: 'Lifestyle Data', icon: 'running' },
            { key: 'mental_health_data', label: 'Mental Health', icon: 'brain' },
            { key: 'family_history', label: 'Family History', icon: 'dna' }
        ];
        
        let html = '<div class="data-type-grid">';
        
        dataTypes.forEach(type => {
            const hasData = data[type.key] && (Array.isArray(data[type.key]) ? data[type.key].length > 0 : Object.keys(data[type.key]).length > 0);
            const iconColor = hasData ? 'success' : 'secondary';
            const statusText = hasData ? 'Available' : 'Not Added';
            const statusClass = hasData ? 'status-available' : 'status-not-added';
            
            html += `
                <div class="data-type-item">
                    <i class="fas fa-${type.icon} fa-2x text-${iconColor} data-icon"></i>
                    <div class="data-info">
                        <div class="data-label">${type.label}</div>
                        <div class="data-status ${statusClass}">${statusText}</div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        completenessDiv.innerHTML = html;
    }

    async function generateAssessment() {
        if (!confirm('Generate a new risk assessment? This will analyze all your health data.')) {
            return;
        }
        
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
        
        try {
            const result = await apiCall('/api/assessment/generate', 'POST');
            
            if (result.success) {
                alert('Risk assessment generated successfully!');
                window.location.href = '/risk-report';
            } else {
                alert(result.error || 'Failed to generate assessment');
            }
        } catch (error) {
            console.error('Error generating assessment:', error);
            alert('Failed to generate assessment. Please try again.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Generate Now';
        }
    }

    async function searchDoctors() {
        const btn = document.getElementById('doctorSearchBtn');
        const area = 'Nagpur';
        const latStr = '';
        const lonStr = '';
        const radius = parseFloat(document.getElementById('doctorRadius').value) || 20;

        const resultsDiv = document.getElementById('doctorResults');
        resultsDiv.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">Searching doctors...</p>
            </div>
        `;
        btn.disabled = true;

        try {
            let url = `/api/doctors/search?radius_km=${encodeURIComponent(radius)}&area=${encodeURIComponent(area)}`;

            // Use authenticated call (works for public or protected endpoints)
            const result = await apiCall(url);
            if (!result || !result.success) {
                throw new Error(result && result.error ? result.error : 'Search failed');
            }
            renderDoctorResults(result.results, result.radius_km);
        } catch (err) {
            console.error('Doctor search error:', err);
            resultsDiv.innerHTML = `<div class="alert alert-danger">${err.message || 'Failed to search doctors'}</div>`;
        } finally {
            btn.disabled = false;
        }
    }

    function renderDoctorResults(items, radius) {
        const resultsDiv = document.getElementById('doctorResults');
        if (!items || items.length === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-info">No doctors found within ${radius} km.</div>`;
            return;
        }

        let html = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 style="color: var(--heading-color);">Results (${items.length})</h6>
                <small class="text-muted">Radius: ${radius} km</small>
            </div>
        `;

        html += '<div class="list-group">';
        items.forEach((doc) => {
            const name = doc.name || doc.full_name || (doc.first_name && doc.last_name ? `${doc.first_name} ${doc.last_name}` : 'Unknown');
            const specialties = doc.specialty || (Array.isArray(doc.specialties) ? doc.specialties.join(', ') : '') || '';
            const phone = doc.phone || (doc.contact && doc.contact.phone) || '';
            const addrObj = doc.address || doc.location || {};
            const address = typeof addrObj === 'string' ? addrObj : [addrObj.street, addrObj.city, addrObj.state, addrObj.zip].filter(Boolean).join(', ');
            const dist = (doc.distance_km !== undefined) ? `${doc.distance_km} km` : '';

            html += `
                <a class="list-group-item list-group-item-action" style="background-color: var(--card-bg); border-color: var(--card-border);">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1" style="color: var(--heading-color);">${name}</h6>
                        <small class="text-muted">${dist}</small>
                    </div>
                    <p class="mb-1" style="color: var(--text-color);">${specialties || 'Doctor'}</p>
                    <small class="text-muted">${address || ''} ${phone ? ' â€¢ ' + phone : ''}</small>
                </a>
            `;
        });
        html += '</div>';
        resultsDiv.innerHTML = html;
    }
</script>
{% endblock %}
